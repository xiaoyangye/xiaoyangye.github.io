<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>YE AI Studio (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      ::-webkit-scrollbar { width: 8px; height: 8px; }
      ::-webkit-scrollbar-track { background: #1e1e1e; }
      ::-webkit-scrollbar-thumb { background: #424242; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1e1e1e;
        color: #cccccc;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
      textarea {
        caret-color: white;
        scrollbar-gutter: stable;
      }
      .resizer {
        width: 4px;
        cursor: col-resize;
        background: #1e1e1e;
        transition: background 0.2s;
        z-index: 50;
        flex-shrink: 0;
      }
      .resizer:hover, .resizing {
        background: #007acc !important;
      }
      .typo-prose {
        font-family: 'Times New Roman', serif;
      }
      .is-resizing {
        user-select: none;
        pointer-events: none;
      }
      .is-resizing * {
        pointer-events: none !important;
      }
      /* Typst specific styling for the UI preview */
      .typo-prose ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
      .typo-prose ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
      .typo-prose p { margin-bottom: 1rem; line-height: 1.6; }
      .text-center { text-align: center; }
      .text-right { text-align: right; }
      .text-left { text-align: left; }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "lucide-react": "https://esm.sh/lucide-react@^0.561.0",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef, useCallback } = React;

      // --- ICONS ---
      const IconFiles = ({ size = 20, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
      );
      const IconPlus = ({ size = 14 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      );
      const IconTrash = ({ size = 14 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
      );
      const IconFileText = ({ size = 14, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      );
      const IconPlay = ({ size = 14, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
      );
      const IconDownload = ({ size = 14, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      );
      const IconChevronDown = ({ size = 12 }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
      );

      const TEMPLATES = {
        'Simple': `= Simple Document\n\n#set text(font: "Linux Libertine", size: 12pt)\n#set page(paper: "a4")\n\n#align(center)[\n  = Centered Header\n]\n\nHello, this is a basic *Typst* document.\n\n#align(center)[\n  This text is centered using the align function.\n]\n\n== Section 1\n\n- Unnumbered Item A\n- Unnumbered Item B\n\n1. Numbered Item 1\n2. Numbered Item 2\n\n$ E = m c^2 $`,
        'Resume': `#set page(margin: (x: 1cm, y: 1cm))\n\n#align(center)[\n  = John Doe\n  john@example.com | +1 234 567 890\n]\n\n== Experience\n*Senior Software Engineer* @ Tech Corp\n1. Led a team of 10 engineers\n2. Improved performance by 40%`,
        'Scientific': `= On the Nature of Things\n\n#align(center)[*Abstract*]\n\nThis paper discusses the local browser-based compilation...\n\n== Introduction\nAs shown by @smith2023, Typst is a powerful new tool.`
      };

      const localCompileTypst = (code) => {
        try {
          // Remove #set and #let lines entirely
          let processed = code.replace(/^#set .*$/gm, '').replace(/^#let .*$/gm, '');
          
          // Escape HTML characters
          processed = processed.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");

          const processInner = (text) => {
            let t = text.trim();

            // Headers
            t = t.replace(/^= (.+)$/gm, '<h1 class="text-3xl font-bold mb-4 mt-6 pb-2 border-b border-gray-200">$1</h1>');
            t = t.replace(/^== (.+)$/gm, '<h2 class="text-2xl font-semibold mb-3 mt-5 text-gray-800">$1</h2>');
            t = t.replace(/^=== (.+)$/gm, '<h3 class="text-xl font-semibold mb-2 mt-4 text-gray-700">$1</h3>');

            // List items tagging
            t = t.replace(/^(\d+\.| \+) (.+)$/gm, '<li class="numbered-item">$2</li>');
            t = t.replace(/^- (.+)$/gm, '<li class="bullet-item">$1</li>');

            // Wrap items into containers
            t = t.replace(/(<li class="numbered-item">[\s\S]*?<\/li>\n?)+/g, match => `<ol class="list-decimal ml-6 mb-4">${match.replace(/numbered-item/g, '')}</ol>`);
            t = t.replace(/(<li class="bullet-item">[\s\S]*?<\/li>\n?)+/g, match => `<ul class="list-disc ml-6 mb-4">${match.replace(/bullet-item/g, '')}</ul>`);

            // Math (non-greedy, single line)
            t = t.replace(/\$([^\$\n]+)\$/g, '<span class="italic text-blue-800 bg-blue-50 px-1 rounded">Math($1)</span>');

            // Bold and Italic
            t = t.replace(/\*([^\*]+)\*/g, '<strong>$1</strong>');
            t = t.replace(/_([^_]+)_/g, '<em>$1</em>');

            // Paragraphs split
            let parts = t.split(/\n\n+/);
            t = parts.map(p => {
              // If it already looks like a block, don't wrap in <p>
              if (p.trim().startsWith('<h') || p.trim().startsWith('<ol') || p.trim().startsWith('<ul') || p.trim().startsWith('<div')) {
                return p;
              }
              return `<p class="mb-4">${p.replace(/\n/g, '<br/>')}</p>`;
            }).join('');

            return t;
          };

          // Alignment blocks
          processed = processed.replace(/#align\((center|left|right)\)\[([\s\S]*?)\]/g, (match, pos, content) => {
            return `<div class="text-${pos}">${processInner(content)}</div>`;
          });

          // Process the rest
          processed = processInner(processed);

          return { html: `<div class="typo-prose">${processed}</div>` };
        } catch (e) {
          return { error: e.message };
        }
      };

      const Sidebar = ({ files, activeFileId, onSelectFile, onAddFile, onDeleteFile, width }) => {
        const [showTemplates, setShowTemplates] = useState(false);

        return (
          <div style={{ width: width }} className="bg-[#252526] flex flex-col text-[#cccccc] h-full border-r border-[#1e1e1e] select-none flex-shrink-0">
            <div className="h-9 px-4 flex items-center justify-between text-xs font-bold uppercase tracking-wider text-[#bbbbbb]">
              <span className={width < 80 ? "hidden" : ""}>Explorer</span>
              <div className="relative">
                <button 
                  className="hover:bg-[#3c3c3c] rounded p-1 flex items-center gap-1 transition-colors" 
                  onClick={() => setShowTemplates(!showTemplates)} 
                  title="New Document"
                >
                  <IconPlus size={14} />
                  {width > 120 && <IconChevronDown size={10} />}
                </button>
                {showTemplates && (
                  <>
                    <div className="fixed inset-0 z-40" onClick={() => setShowTemplates(false)}></div>
                    <div className="absolute top-full right-0 mt-1 bg-[#252526] border border-[#3e3e42] shadow-2xl z-50 py-1 w-40 rounded">
                      <div className="px-3 py-1.5 text-[10px] text-gray-500 font-bold uppercase border-b border-[#3e3e42]">Select Template</div>
                      {Object.keys(TEMPLATES).map(t => (
                        <button 
                          key={t}
                          className="w-full text-left px-3 py-2 text-xs hover:bg-[#007acc] text-white transition-colors"
                          onClick={() => {
                            onAddFile(t);
                            setShowTemplates(false);
                          }}
                        >
                          {t}
                        </button>
                      ))}
                      <button 
                        className="w-full text-left px-3 py-2 text-xs hover:bg-[#007acc] text-white border-t border-[#3e3e42] transition-colors"
                        onClick={() => {
                          onAddFile('Blank');
                          setShowTemplates(false);
                        }}
                      >
                        Blank File
                      </button>
                    </div>
                  </>
                )}
              </div>
            </div>
            <div className="flex-1 overflow-y-auto mt-2">
              {files.map(file => (
                <div 
                  key={file.id}
                  className={`group flex items-center px-4 py-1.5 cursor-pointer text-sm ${activeFileId === file.id ? 'bg-[#37373d] text-white' : 'hover:bg-[#2a2d2e]'}`}
                  onClick={() => onSelectFile(file.id)}
                >
                  <IconFileText size={14} className="mr-2 text-[#42a5f5] flex-shrink-0" />
                  <span className={`truncate flex-1 ${width < 50 ? 'hidden' : ''}`}>{file.name}</span>
                  {files.length > 1 && width > 120 && (
                    <button 
                      className="ml-2 opacity-0 group-hover:opacity-100 hover:text-red-400 p-1 rounded transition-opacity"
                      onClick={(e) => { e.stopPropagation(); onDeleteFile(file.id); }}
                      title="Delete file"
                    >
                      <IconTrash size={12} />
                    </button>
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      };

      const Editor = ({ file, onUpdateContent }) => {
        const textareaRef = useRef(null);
        const [lineCount, setLineCount] = useState(1);
        
        useEffect(() => {
          if (file) setLineCount(file.content.split('\n').length);
        }, [file?.content]);

        const handleScroll = (e) => {
          const lineNumbers = document.getElementById('line-numbers');
          if (lineNumbers) lineNumbers.scrollTop = e.target.scrollTop;
        };

        const handleDownload = () => {
          if (!file) return;
          const blob = new Blob([file.content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = file.name;
          a.click();
          URL.revokeObjectURL(url);
        };

        if (!file) return <div className="flex-1 bg-[#1e1e1e] flex items-center justify-center text-[#333] text-6xl font-bold uppercase select-none">Typst</div>;

        return (
          <div className="flex-1 flex flex-col bg-[#1e1e1e] h-full overflow-hidden min-w-0">
            <div className="h-9 bg-[#2d2d2d] flex items-center justify-between px-4 text-xs text-white border-b border-[#1e1e1e]">
              <div className="flex items-center gap-2">
                <span className="opacity-40 uppercase">Write Something Great!</span>
                <span className="font-semibold">{file.name}</span>
              </div>
              <button 
                onClick={handleDownload}
                className="hover:bg-[#3c3c3c] p-1.5 rounded transition-colors"
                title="Download source code"
              >
                <IconDownload size={14} />
              </button>
            </div>

            <div className="flex-1 flex overflow-hidden relative">
              <div id="line-numbers" className="w-10 bg-[#1e1e1e] text-[#858585] text-right pr-2 pt-4 text-[10px] font-mono select-none overflow-hidden leading-6 border-r border-[#333]">
                {Array.from({ length: Math.max(lineCount, 60) }).map((_, i) => <div key={i}>{i + 1}</div>)}
              </div>
              <textarea
                ref={textareaRef}
                className="flex-1 bg-[#1e1e1e] text-[#d4d4d4] p-4 pt-4 outline-none resize-none font-mono text-sm leading-6 whitespace-pre overflow-auto scrollbar-thin"
                value={file.content}
                onChange={(e) => onUpdateContent(file.id, e.target.value)}
                onScroll={handleScroll}
                spellCheck={false}
              />
            </div>
          </div>
        );
      };

      const Preview = ({ htmlContent, width, isLoading, onRefresh }) => {
        const handlePrint = () => {
          if (!htmlContent) return;
          const win = window.open('', '_blank');
          if (win) {
            win.document.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <title>Typst Export</title>
                  <script src="https://cdn.tailwindcss.com"><\/script>
                  <style>
                    @page { size: A4; margin: 0; }
                    body { margin: 0; padding: 0; background: white; font-family: 'Times New Roman', serif; }
                    .print-area { width: 21cm; padding: 2.5cm; margin: auto; }
                    h1 { font-size: 2.25rem; font-weight: 700; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 0.5rem; }
                    h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
                    h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; }
                    p { margin-bottom: 1rem; line-height: 1.6; }
                    ul { list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem; }
                    ol { list-style-type: decimal; margin-left: 1.5rem; margin-bottom: 1rem; }
                    .text-center { text-align: center; }
                    .text-right { text-align: right; }
                    .text-left { text-align: left; }
                  </style>
                </head>
                <body>
                  <div class="print-area">${htmlContent}</div>
                  <script>
                    window.onload = () => {
                      setTimeout(() => {
                        window.print();
                        window.close();
                      }, 500);
                    };
                  <\/script>
                <script type="module" src="/index.tsx"></script>
</body>
              </html>
            `);
            win.document.close();
          }
        };

        return (
          <div style={{ width: width }} className="flex flex-col bg-[#ffffff] h-full overflow-hidden border-l border-[#333] flex-shrink-0">
            <div className="h-9 bg-[#2d2d2d] flex items-center justify-between px-4 text-xs text-white border-b border-[#1e1e1e]">
              <span className="font-bold opacity-60">PREVIEW</span>
              <div className="flex gap-2">
                <button 
                  onClick={handlePrint} 
                  className="bg-[#3c3c3c] hover:bg-[#505050] px-3 py-1 rounded text-xs flex items-center transition-colors" 
                  disabled={!htmlContent}
                >
                  <IconDownload size={12} className="mr-1" /> PDF
                </button>
                <button onClick={onRefresh} className="bg-[#0e639c] hover:bg-[#1177bb] px-3 py-1 rounded text-xs flex items-center transition-colors">
                  {isLoading ? '...' : <IconPlay size={10} className="mr-1" />} Render
                </button>
              </div>
            </div>
            <div className="flex-1 overflow-auto bg-[#3e3e42] p-4">
              <div className="bg-white shadow-xl min-h-[29.7cm] w-full max-w-[21cm] mx-auto p-12 typo-prose text-black">
                <div dangerouslySetInnerHTML={{ __html: htmlContent }} />
                {!htmlContent && !isLoading && <div className="text-gray-400 text-center mt-32 text-xl font-bold uppercase opacity-20 select-none">Ready to Render</div>}
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const [files, setFiles] = useState([
          { id: '1', name: 'main.typ', content: TEMPLATES.Simple }
        ]);
        const [activeFileId, setActiveFileId] = useState('1');
        const [sidebarWidth, setSidebarWidth] = useState(240);
        const [previewWidth, setPreviewWidth] = useState(500);
        const [previewHtml, setPreviewHtml] = useState('');
        const [loading, setLoading] = useState(false);
        const [resizing, setResizing] = useState(null);

        const activeFile = files.find(f => f.id === activeFileId);

        const handleCompile = useCallback(() => {
          if (!activeFile) return;
          setLoading(true);
          setTimeout(() => {
            const res = localCompileTypst(activeFile.content);
            setPreviewHtml(res.html);
            setLoading(false);
          }, 300);
        }, [activeFile]);

        useEffect(() => { handleCompile(); }, [activeFileId, handleCompile]);

        const handleMouseMove = useCallback((e) => {
          if (resizing === 'sidebar') {
            setSidebarWidth(Math.max(40, Math.min(e.clientX - 48, 450)));
          } else if (resizing === 'preview') {
            setPreviewWidth(Math.max(200, Math.min(window.innerWidth - e.clientX, window.innerWidth - sidebarWidth - 100)));
          }
        }, [resizing, sidebarWidth]);

        const handleMouseUp = useCallback(() => setResizing(null), []);

        useEffect(() => {
          if (resizing) {
            window.addEventListener('mousemove', handleMouseMove);
            window.addEventListener('mouseup', handleMouseUp);
            document.body.classList.add('is-resizing');
          } else {
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            document.body.classList.remove('is-resizing');
          }
          return () => {
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
            document.body.classList.remove('is-resizing');
          };
        }, [resizing, handleMouseMove, handleMouseUp]);

        const deleteFile = (id) => {
          if (files.length <= 1) return;
          const newFiles = files.filter(f => f.id !== id);
          setFiles(newFiles);
          if (activeFileId === id) setActiveFileId(newFiles[0].id);
        };

        const addFile = (templateKey) => {
          const id = Date.now().toString();
          const content = templateKey === 'Blank' ? '= Untitled\n\nStart typing...' : (TEMPLATES[templateKey] || '');
          const newFile = { id, name: `doc-${files.length + 1}.typ`, content };
          setFiles([...files, newFile]);
          setActiveFileId(id);
        };

        return (
          <div className="flex flex-col h-screen w-screen overflow-hidden bg-[#1e1e1e]">
            <div className="flex-1 flex overflow-hidden">
              <div className="w-12 bg-[#333333] flex flex-col items-center py-4 gap-6 text-[#858585] flex-shrink-0">
                <IconFiles className="text-white" />
              </div>
              
              <Sidebar 
                files={files} 
                activeFileId={activeFileId} 
                onSelectFile={setActiveFileId} 
                onAddFile={addFile}
                onDeleteFile={deleteFile}
                width={sidebarWidth}
              />
              
              <div className={`resizer ${resizing === 'sidebar' ? 'resizing' : ''}`} onMouseDown={() => setResizing('sidebar')} />
              
              <Editor file={activeFile} onUpdateContent={(id, content) => {
                setFiles(prev => prev.map(f => f.id === id ? { ...f, content } : f));
              }} />
              
              <div className={`resizer ${resizing === 'preview' ? 'resizing' : ''}`} onMouseDown={() => setResizing('preview')} />
              
              <Preview htmlContent={previewHtml} width={previewWidth} isLoading={loading} onRefresh={handleCompile} />
            </div>
            
            <div className="h-6 bg-[#007acc] text-white flex items-center justify-between px-3 text-[10px] uppercase font-bold select-none flex-shrink-0">
              <div className="flex gap-4">
                <span>Status: Online</span>
              </div>
              <span className="opacity-70">YE AI Studio</span>
            </div>
          </div>
        );
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </body>
</html>
