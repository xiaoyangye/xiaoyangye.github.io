<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typst Studio (Local)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }
      ::-webkit-scrollbar-track {
        background: #1e1e1e; 
      }
      ::-webkit-scrollbar-thumb {
        background: #424242; 
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #4f4f4f; 
      }
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1e1e1e;
        color: #cccccc;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      textarea {
        caret-color: white;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-presets="react,env">
      // Globals from UMD scripts
      const { useState, useEffect, useRef, useCallback } = React;

      // --- ICONS ---
      const IconFiles = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
      );
      const IconSearch = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      );
      const IconSettings = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      );
      const IconChevronDown = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 12 15 18 9"/></svg>
      );
      const IconPlus = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      );
      const IconFileText = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      );
      const IconDownload = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      );
      const IconPlay = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>
      );
      const IconRadio = ({ size = 24, className = "" }) => (
         <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"/><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"/><circle cx="12" cy="12" r="2"/><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"/><path d="M19.1 4.9C23 8.8 23 15.1 19.1 19.1"/></svg>
      );
      const IconLoader = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></svg>
      );
      const IconAlert = ({ size = 24, className = "" }) => (
        <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
      );

      // --- CONSTANTS ---
      const ActivityView = {
        EXPLORER: 'EXPLORER',
        SEARCH: 'SEARCH',
        SETTINGS: 'SETTINGS'
      };

      const INITIAL_FILES = [
        {
          id: '1',
          name: 'main.typ',
          language: 'typst',
          content: `= My Local Document

This is a simplified local version of Typst Studio. It runs entirely in your browser.

== Features

- **Offline**: Works without a build server.
- **Fast**: Instant regex-based compilation.
- **Download**: Save as PDF.

== Formatting

You can use *bold* text, _italic_ text, and lists.

- Item 1
- Item 2

== Code

\`\`\`
print("Hello World")
\`\`\`
`
        }
      ];

      // --- LOCAL COMPILER SERVICE ---
      const localCompileTypst = (code) => {
        try {
          // Escape HTML
          let safeCode = code
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");

          // Headings
          safeCode = safeCode.replace(/^= (.+)$/gm, '<h1 class="text-3xl font-bold mb-4 mt-6 pb-2 border-b border-gray-200">$1</h1>');
          safeCode = safeCode.replace(/^== (.+)$/gm, '<h2 class="text-2xl font-semibold mb-3 mt-5 text-gray-800">$1</h2>');
          safeCode = safeCode.replace(/^=== (.+)$/gm, '<h3 class="text-xl font-semibold mb-2 mt-4 text-gray-700">$1</h3>');

          // Bold (*text*)
          safeCode = safeCode.replace(/\*([^\*]+)\*/g, '<strong>$1</strong>');
          
          // Italic (_text_)
          safeCode = safeCode.replace(/_([^_]+)_/g, '<em>$1</em>');

          // Code blocks (```code```)
          safeCode = safeCode.replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-3 rounded my-4 overflow-x-auto text-sm font-mono text-gray-800">$1</pre>');
          
          // Inline code (`code`)
          safeCode = safeCode.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-1 rounded text-sm font-mono text-pink-600">$1</code>');

          // Lists
          safeCode = safeCode.replace(/^- (.+)$/gm, '<li class="ml-6 list-disc mb-1">$1</li>');
          
          // Paragraphs
          safeCode = safeCode.replace(/\n\n/g, '<br/><br/>');

          // Math stub
          safeCode = safeCode.replace(/\$([^$]+)\$/g, '<span class="font-serif italic text-blue-800 bg-blue-50 px-1 rounded">Math($1)</span>');

          // Remove let
          safeCode = safeCode.replace(/^#let .*$/gm, '');

          // Function calls
          safeCode = safeCode.replace(/#([a-zA-Z0-9_]+)/g, '<span class="text-purple-600 font-bold">#$1</span>');

          return { html: `<div class="font-serif leading-relaxed text-gray-900">${safeCode}</div>` };
        } catch (e) {
          return { error: e.message };
        }
      };


      // --- COMPONENTS ---

      const ActivityBar = ({ activeView, setActiveView }) => {
        const icons = [
          { view: ActivityView.EXPLORER, icon: IconFiles, label: 'Explorer' },
          { view: ActivityView.SEARCH, icon: IconSearch, label: 'Search' },
        ];

        return (
          <div className="w-12 flex flex-col items-center py-2 bg-[#333333] text-[#858585] justify-between h-full select-none z-20">
            <div className="flex flex-col gap-6">
              {icons.map((item) => (
                <div
                  key={item.view}
                  className={`cursor-pointer p-2 relative group ${activeView === item.view ? 'text-white' : 'hover:text-white'}`}
                  onClick={() => setActiveView(item.view)}
                  title={item.label}
                >
                   {activeView === item.view && (
                      <div className="absolute left-0 top-0 bottom-0 w-[2px] bg-white -ml-2" />
                   )}
                  <item.icon size={24} className={activeView === item.view ? 'text-white' : ''} />
                </div>
              ))}
            </div>
            
            <div className="pb-2">
               <div 
                  className={`cursor-pointer p-2 ${activeView === ActivityView.SETTINGS ? 'text-white' : 'hover:text-white'}`}
                  onClick={() => setActiveView(ActivityView.SETTINGS)}
               >
                  <IconSettings size={24} />
               </div>
            </div>
          </div>
        );
      };

      const Sidebar = ({ files, activeFileId, onSelectFile, onAddFile }) => {
        return (
          <div className="w-60 bg-[#252526] flex flex-col text-[#cccccc] h-full border-r border-[#1e1e1e]">
            <div className="h-9 px-4 flex items-center text-xs font-bold uppercase tracking-wider text-[#bbbbbb]">
              Explorer
            </div>
            
            <div className="flex-1 overflow-y-auto">
              <div className="px-2">
                  <div className="flex items-center py-1 cursor-pointer font-bold text-xs text-white">
                      <IconChevronDown size={14} className="mr-1" />
                      <span>WORKSPACE</span>
                      <div className="ml-auto hover:bg-[#3c3c3c] rounded p-0.5" onClick={(e) => { e.stopPropagation(); onAddFile(); }}>
                          <IconPlus size={14} />
                      </div>
                  </div>
                  
                  <div className="mt-1">
                      {files.map(file => (
                          <div 
                              key={file.id}
                              className={`
                                  flex items-center px-4 py-1 cursor-pointer text-sm
                                  ${activeFileId === file.id ? 'bg-[#37373d] text-white' : 'hover:bg-[#2a2d2e]'}
                              `}
                              onClick={() => onSelectFile(file.id)}
                          >
                              <IconFileText size={14} className="mr-2 text-[#42a5f5]" />
                              <span className="truncate">{file.name}</span>
                              {file.isUnsaved && <div className="ml-auto w-2 h-2 rounded-full bg-white opacity-60" />}
                          </div>
                      ))}
                  </div>
              </div>
            </div>
          </div>
        );
      };

      const Editor = ({ file, onUpdateContent }) => {
        const [lineCount, setLineCount] = useState(1);
        const textareaRef = useRef(null);
        
        useEffect(() => {
          if (file) {
            setLineCount(file.content.split('\n').length);
          }
        }, [file?.content]);

        const handleScroll = (e) => {
          const target = e.target;
          const lineNumbers = document.getElementById('line-numbers');
          if (lineNumbers) {
            lineNumbers.scrollTop = target.scrollTop;
          }
        };

        const handleChange = (e) => {
           if (file) {
               onUpdateContent(file.id, e.target.value);
           }
        };

        if (!file) {
          return (
            <div className="flex-1 bg-[#1e1e1e] flex items-center justify-center text-[#555]">
              <div className="flex flex-col items-center">
                   <div className="mb-4 text-6xl opacity-20">âŒ˜</div>
                   <p>Select a file to edit</p>
              </div>
            </div>
          );
        }

        return (
          <div className="flex-1 flex flex-col bg-[#1e1e1e] h-full overflow-hidden relative">
            <div className="h-9 bg-[#2d2d2d] flex items-center px-4 text-sm text-white border-b border-[#1e1e1e]">
              <span className="opacity-60 mr-2 italic">{file.language}</span>
              <span>{file.name}</span>
            </div>

            <div className="flex-1 flex relative">
              <div 
                  id="line-numbers"
                  className="w-12 bg-[#1e1e1e] text-[#858585] text-right pr-3 pt-4 text-sm font-mono select-none overflow-hidden leading-6"
                  style={{ borderRight: '1px solid #333' }}
              >
                {Array.from({ length: Math.max(lineCount, 30) }).map((_, i) => (
                  <div key={i}>{i + 1}</div>
                ))}
              </div>

              <textarea
                  ref={textareaRef}
                  className="flex-1 bg-[#1e1e1e] text-[#d4d4d4] p-4 pt-4 outline-none resize-none font-mono text-sm leading-6 whitespace-pre"
                  value={file.content}
                  onChange={handleChange}
                  onScroll={handleScroll}
                  spellCheck={false}
              />
            </div>
          </div>
        );
      };

      const Preview = ({ htmlContent, isLoading, error, onRefresh }) => {
        const handleDownloadPdf = () => {
          if (!htmlContent) return;

          const printWindow = window.open('', '_blank', 'width=800,height=1100');
          if (printWindow) {
            // Use escaped characters to prevent the HTML parser from prematurely closing the main script tag
            // when it sees < / script >
            const html = `
              \x3C!DOCTYPE html\x3E
              \x3Chtml\x3E
                \x3Chead\x3E
                  \x3Ctitle\x3EDocument\x3C/title\x3E
                  \x3Cscript src="https://cdn.tailwindcss.com"\x3E\x3C/script\x3E
                  \x3Cstyle\x3E
                    @page { size: A4; margin: 0; }
                    body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; }
                    .print-content { width: 21cm; min-height: 29.7cm; padding: 2cm; margin: auto; }
                    .typo-prose { font-family: serif; line-height: 1.5; }
                    h1 { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; border-bottom: 1px solid #eee; }
                    h2 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
                    ul { list-style-type: disc; margin-left: 1.5em; }
                  \x3C/style\x3E
                \x3C/head\x3E
                \x3Cbody\x3E
                  \x3Cdiv class="print-content typo-prose"\x3E
                    ${htmlContent}
                  \x3C/div\x3E
                  \x3Cscript\x3E
                    window.onload = function() { window.print(); }
                  \x3C/script\x3E
                \x3C/body\x3E
              \x3C/html\x3E
            `;
            printWindow.document.write(html);
            printWindow.document.close();
          }
        };

        return (
          <div className="flex-1 flex flex-col bg-[#ffffff] h-full overflow-hidden border-l border-[#333]">
            <div className="h-9 bg-[#2d2d2d] flex items-center justify-between px-4 text-sm text-white border-b border-[#1e1e1e]">
              <span className="font-semibold tracking-wide">PREVIEW (LOCAL)</span>
              <div className="flex items-center gap-2">
                  <button
                      onClick={handleDownloadPdf}
                      className="text-xs bg-[#3c3c3c] hover:bg-[#505050] px-3 py-1 rounded text-white flex items-center transition-colors disabled:opacity-50"
                      disabled={!htmlContent || isLoading || !!error}
                      title="Print to PDF"
                  >
                      <IconDownload size={12} className="mr-2" />
                      Download PDF
                  </button>
                  <button 
                      onClick={onRefresh}
                      className="text-xs bg-[#0e639c] hover:bg-[#1177bb] px-3 py-1 rounded text-white flex items-center transition-colors"
                      disabled={isLoading}
                  >
                      {isLoading ? <IconLoader className="animate-spin mr-2" size={12} /> : <IconPlay size={12} className="mr-2" />}
                      {isLoading ? 'Rendering...' : 'Render'}
                  </button>
              </div>
            </div>

            <div className="flex-1 overflow-auto bg-gray-100 p-8 relative">
              {error ? (
                 <div className="bg-red-50 border border-red-200 rounded p-4 text-red-700 flex items-start">
                    <IconAlert size={18} className="mr-2" />
                    <div>
                        <h3 className="font-bold">Rendering Error</h3>
                        <p className="text-sm mt-1">{error}</p>
                    </div>
                 </div>
              ) : (
                  <div 
                      className="bg-white shadow-lg min-h-[29.7cm] w-[21cm] mx-auto p-12 text-black typo-prose"
                      dangerouslySetInnerHTML={{ __html: htmlContent }}
                      style={{ fontFamily: 'serif' }} 
                  />
              )}
              
              {!htmlContent && !isLoading && !error && (
                  <div className="absolute inset-0 flex items-center justify-center opacity-40 pointer-events-none">
                      <div className="text-center">
                          <h2 className="text-2xl font-bold text-gray-400 mb-2">Typst Local Preview</h2>
                          <p className="text-gray-400">Click "Render" to preview</p>
                      </div>
                  </div>
              )}
            </div>
          </div>
        );
      };

      const StatusBar = ({ line, col, isSaving }) => {
        return (
          <div className="h-6 bg-[#007acc] text-white flex items-center justify-between px-3 text-xs select-none z-30">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-1 font-bold">
                  <IconRadio size={12} />
                  <span>LOCAL</span>
              </div>
              <div>
                  master*
              </div>
              {isSaving && <span>Saving...</span>}
            </div>

            <div className="flex items-center gap-4">
               <div className="hover:bg-white/10 px-1 rounded cursor-pointer">
                  Ln {line}, Col {col}
               </div>
               <div className="hover:bg-white/10 px-1 rounded cursor-pointer">
                  UTF-8
               </div>
               <div className="hover:bg-white/10 px-1 rounded cursor-pointer">
                  Typst
               </div>
            </div>
          </div>
        );
      };

      // --- MAIN APP ---

      const App = () => {
        const [files, setFiles] = useState(INITIAL_FILES);
        const [activeFileId, setActiveFileId] = useState('1');
        const [activeView, setActiveView] = useState(ActivityView.EXPLORER);
        const [previewHtml, setPreviewHtml] = useState('');
        const [isPreviewLoading, setIsPreviewLoading] = useState(false);
        const [previewError, setPreviewError] = useState(undefined);

        const activeFile = files.find(f => f.id === activeFileId) || null;

        const handleUpdateContent = useCallback((id, newContent) => {
          setFiles(prev => prev.map(f => f.id === id ? { ...f, content: newContent, isUnsaved: true } : f));
        }, []);

        const handleSelectFile = (id) => {
          setActiveFileId(id);
        };

        const handleAddFile = () => {
          const newFile = {
              id: Date.now().toString(),
              name: `untitled-${files.length + 1}.typ`,
              language: 'typst',
              content: '= New Document\n\nStart typing...'
          };
          setFiles([...files, newFile]);
          setActiveFileId(newFile.id);
        };

        const handleCompile = async () => {
          if (!activeFile) return;
          
          setIsPreviewLoading(true);
          setPreviewError(undefined);
          
          // Small delay to simulate processing
          setTimeout(() => {
             const result = localCompileTypst(activeFile.content);
             
             if (result.error) {
                 setPreviewError(result.error);
             } else {
                 setPreviewHtml(result.html);
             }
             setIsPreviewLoading(false);
          }, 300);
        };

        // Initial compile
        useEffect(() => {
          if (activeFile && !previewHtml) {
            handleCompile();
          }
        }, []);

        return (
          <div className="flex flex-col h-screen w-screen overflow-hidden bg-[#1e1e1e]">
            <div className="flex-1 flex overflow-hidden">
              <ActivityBar activeView={activeView} setActiveView={setActiveView} />
              
              {activeView === ActivityView.EXPLORER && (
                  <Sidebar 
                      files={files} 
                      activeFileId={activeFileId} 
                      onSelectFile={handleSelectFile}
                      onAddFile={handleAddFile}
                  />
              )}

              <div className="flex-1 flex min-w-0 relative">
                  <div className="flex-1 flex flex-col min-w-0">
                      <Editor 
                          file={activeFile} 
                          onUpdateContent={handleUpdateContent} 
                      />
                  </div>
                  
                  <div className="flex-1 flex flex-col min-w-0 border-l border-[#333]">
                      <Preview 
                          htmlContent={previewHtml} 
                          isLoading={isPreviewLoading}
                          error={previewError}
                          onRefresh={handleCompile}
                      />
                  </div>
              </div>
            </div>

            <StatusBar line={1} col={1} isSaving={false} />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>